<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>Fabric Madness: Feature Engineering with pyspark &#183; Data Simplicity</title>
<meta name=title content="Fabric Madness: Feature Engineering with pyspark &#183; Data Simplicity"><meta name=description content="In part 2 of this series we dive deeper into the process of feature engineering, a crucial part of the development lifecycle for any Machine Learning (ML) systems."><meta name=keywords content="Microsoft Fabric,Spark,"><link rel=canonical href=https://nobledynamic.github.io/posts/fabric-madness-2/><link type=text/css rel=stylesheet href=/css/main.bundle.min.5df62440e5b4837dcda2e55665cc9bad3ee1748c30cd928b8deea3c9cd2c5e716dbb602258b4df843a1a29155688a0d50d245816d46c48c0430d98eb00526528.css integrity="sha512-XfYkQOW0g33NouVWZcybrT7hdIwwzZKLje6jyc0sXnFtu2AiWLTfhDoaKRVWiKDVDSRYFtRsSMBDDZjrAFJlKA=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.d6c35110b5d7df8014403fbb81cd21a9d89daf9eb586c936e585e9d04adc204dce554aa737f81e8c902b9dea9e67bd63a977b77dedefb8a39430581ebc519207.js integrity="sha512-1sNRELXX34AUQD+7gc0hqdidr561hsk25YXp0ErcIE3OVUqnN/gejJArneqeZ71jqXe3fe3vuKOUMFgevFGSBw==" data-copy data-copied></script><script src=/js/zoom.min.js></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://nobledynamic.github.io/posts/fabric-madness-2/"><meta property="og:site_name" content="Data Simplicity"><meta property="og:title" content="Fabric Madness: Feature Engineering with pyspark"><meta property="og:description" content="In part 2 of this series we dive deeper into the process of feature engineering, a crucial part of the development lifecycle for any Machine Learning (ML) systems."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-08T09:37:43+00:00"><meta property="article:modified_time" content="2024-04-08T09:37:43+00:00"><meta property="article:tag" content="Microsoft Fabric"><meta property="article:tag" content="Spark"><meta property="og:image" content="https://nobledynamic.github.io/posts/fabric-madness-2/feature.webp"><meta property="og:see_also" content="https://nobledynamic.github.io/posts/fabric-madness-5/"><meta property="og:see_also" content="https://nobledynamic.github.io/posts/fabric-madness-4/"><meta property="og:see_also" content="https://nobledynamic.github.io/posts/fabric-madness-3/"><meta property="og:see_also" content="https://nobledynamic.github.io/posts/fabric-madness-1/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://nobledynamic.github.io/posts/fabric-madness-2/feature.webp"><meta name=twitter:title content="Fabric Madness: Feature Engineering with pyspark"><meta name=twitter:description content="In part 2 of this series we dive deeper into the process of feature engineering, a crucial part of the development lifecycle for any Machine Learning (ML) systems."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Blog","name":"Fabric Madness: Feature Engineering with pyspark","headline":"Fabric Madness: Feature Engineering with pyspark","abstract":"In part 2 of this series we dive deeper into the process of feature engineering, a crucial part of the development lifecycle for any Machine Learning (ML) systems.","inLanguage":"en","url":"https:\/\/nobledynamic.github.io\/posts\/fabric-madness-2\/","author":{"@type":"Person","name":""},"copyrightYear":"2024","dateCreated":"2024-04-08T09:37:43\u002b00:00","datePublished":"2024-04-08T09:37:43\u002b00:00","dateModified":"2024-04-08T09:37:43\u002b00:00","keywords":["Microsoft Fabric","Spark"],"mainEntityOfPage":"true","wordCount":"2831"}]</script><script src=/lib/jquery/jquery.slim.min.js integrity></script><meta name=theme-color></head><body class="flex flex-col h-screen m-auto text-lg leading-7 bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral" style=height:100%><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div class="fixed inset-x-0 pl-[24px] pr-[24px] bg-neutral dark:bg-neutral-800" style=z-index:100><div class="relative max-w-[64rem] ml-auto mr-auto"><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3"><div><a href=/ class=flex><span class=sr-only>Data Simplicity</span>
<img src=/img/noble-dynamic-logo.svg class="logo object-scale-down object-left nozoom fill-white" style=max-width:7rem alt="Data Simplicity"></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"></nav><nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12"><a href=/#services class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Services</p></a><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Blog</p></a><a href=/#contact class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Contact</p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></nav><div class="flex md:hidden items-center space-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></div></div><div class="-my-2 -mr-2 md:hidden"><label id=menu-button for=menu-controller class=block><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/#services class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Services</p></a></li><li class=mt-1><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Blog</p></a></li><li class=mt-1><a href=/#contact class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Contact</p></a></li></ul></div></label></div></div></div></div><div class="relative flex flex-col grow max-w-[64rem] ml-auto mr-auto sm:px-14 md:px-24 lg:px-32" style="padding:10rem 24px 0"><main id=main-content class=grow><article><div class="w-full h-36 md:h-56 lg:h-72 single_hero_basic nozoom" style=background-image:url(/posts/fabric-madness-2/feature.webp)></div><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Fabric Madness: Feature Engineering with pyspark</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2024-04-08 09:37:43 +0000 UTC">8 April 2024</time><span class="px-2 text-primary-500">&#183;</span><span>2831 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">14 mins</span></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/microsoft-fabric/","_self")'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Microsoft Fabric
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/spark/","_self")'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Spark</span></span></span></div></div><div class="flex author"><div class=place-self-center><div class="text-2xl sm:text-lg"></div></div></div><div class="flex author author-extra mt-4"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 src=/img/martimchaves_hudb276d661e25f7b1da7ea73b8f990b88_34084_192x192_fill_box_center_3.png><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><a href=https://nobledynamic.github.io//authors/martimchaves class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Martim Chaves</a><div class="text-sm text-neutral-700 dark:text-neutral-400">Data Scientist</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://www.linkedin.com/in/martim-chaves-081796186/ target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://medium.com/@mgrc99 target=_blank aria-label=Medium rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentcolor" d="M180.5 74.262C80.813 74.262.0 155.633.0 256S80.819 437.738 180.5 437.738 361 356.373 361 256 280.191 74.262 180.5 74.262zm288.25 10.646c-49.845.0-90.245 76.619-90.245 171.095s40.406 171.1 90.251 171.1 90.251-76.619 90.251-171.1H559C559 161.5 518.6 84.908 468.752 84.908zm139.506 17.821c-17.526.0-31.735 68.628-31.735 153.274s14.2 153.274 31.735 153.274S640 340.631 640 256c0-84.649-14.215-153.271-31.742-153.271z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/MartimChaves target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]"><details open class="toc-right mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#how-does-pyspark-work>How does PySpark Work?</a></li><li><a href=#basics-of-pyspark>Basics of PySpark</a><ul><li><a href=#the-data>The Data</a></li><li><a href=#reading-data>Reading data</a></li><li><a href=#combining-dataframes>Combining DataFrames</a></li><li><a href=#selecting-columns>Selecting Columns</a></li><li><a href=#grouping-data>Grouping Data</a></li><li><a href=#joining-data>Joining Data</a></li><li><a href=#functions>Functions</a></li></ul></li><li><a href=#feature-engineering-in-action>Feature Engineering in Action</a><ul><li><a href=#regular-season-statistics>Regular Season Statistics</a></li><li><a href=#elo-ratings>Elo Ratings</a></li><li><a href=#value-added>Value Added</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#how-does-pyspark-work>How does PySpark Work?</a></li><li><a href=#basics-of-pyspark>Basics of PySpark</a><ul><li><a href=#the-data>The Data</a></li><li><a href=#reading-data>Reading data</a></li><li><a href=#combining-dataframes>Combining DataFrames</a></li><li><a href=#selecting-columns>Selecting Columns</a></li><li><a href=#grouping-data>Grouping Data</a></li><li><a href=#joining-data>Joining Data</a></li><li><a href=#functions>Functions</a></li></ul></li><li><a href=#feature-engineering-in-action>Feature Engineering in Action</a><ul><li><a href=#regular-season-statistics>Regular Season Statistics</a></li><li><a href=#elo-ratings>Elo Ratings</a></li><li><a href=#value-added>Value Added</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></details><script>(function(){var t,e=$("#TableOfContents");if(e.length>0){t=$(window);function n(){var s,o=t.scrollTop(),i=$(".anchor"),n="";if(i.each(function(e,t){t=$(t),t.offset().top-$(window).height()/3<=o&&(n=t.attr("id"))}),s=e.find("a.active"),s.length==1&&s.eq(0).attr("href")=="#"+n)return!0;s.each(function(e,t){$(t).removeClass("active")}),e.find('a[href="#'+n+'"]').addClass("active"),e.find('a[href="#'+n+'"]').parentsUntil("#TableOfContents").each(function(e,t){$(t).children("a").parents("ul").show()})}t.on("scroll",n),$(document).ready(function(){n()})}})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><details style=margin-left:0 class="mt-2 mb-5 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5"><summary class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">Fabric Madness - This article is part of a series.</summary><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://nobledynamic.github.io/posts/fabric-madness-1/>Part 1: Fabric Madness: predicting basketball games with Microsoft Fabric</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">Part 2: This Article</div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://nobledynamic.github.io/posts/fabric-madness-3/>Part 3: Fabric Madness: Feature Engineering with Dataflow Gen2</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://nobledynamic.github.io/posts/fabric-madness-4/>Part 4: Fabric Madness: Experiments</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://nobledynamic.github.io/posts/fabric-madness-5/>Part 5: Fabric Madness: Models</a></div></details><div class="article-content max-w-prose mb-20"><h2 class="relative group">Introduction<div id=introduction class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#introduction aria-label=Anchor>#</a></span></h2><p>In our <a href=/posts/fabric-madness-1/>previous post</a> we took a high level view of how to train a machine learning model in Microsoft Fabric. In this post we wanted to dive deeper into the process of feature engineering.</p><p>Feature engineering is a crucial part of the development lifecycle for any Machine Learning (ML) systems. It is a step in the development cycle where raw data is processed to better represent its underlying structure and provide additional information that enhance our ML models. Feature engineering is both an art and a science. Even though there are specific steps that we can take to create good features, sometimes, it is only through experimentation that good results are achieved. Good features are crucial in guaranteeing a good system performance.</p><p>As datasets grow exponentially, traditional feature engineering may struggle with the size of very large datasets. This is where PySpark can help - as it is a scalable and efficient processing platform for massive datasets. A great thing about Fabric is that it makes using PySpark easy!</p><p>In this post, we&rsquo;ll be going over:</p><ul><li>How does PySpark Work?</li><li>Basics of PySpark</li><li>Feature Engineering in Action</li></ul><p>By the end of this post, hopefully you&rsquo;ll feel comfortable carrying out feature engineering with PySpark in Fabric. Let&rsquo;s get started!</p><h2 class="relative group">How does PySpark Work?<div id=how-does-pyspark-work class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#how-does-pyspark-work aria-label=Anchor>#</a></span></h2><p>Spark is a distributed computing system that allows for the processing of large datasets with speed and efficiency across a cluster of machines. It is built around the concept of a Resilient Distributed Dataset (RDD), which is a fault-tolerant collection of elements that can be operated on in parallel. RDDs are the fundamental data structure of Spark, and they allow for the distribution of data across a cluster of machines.</p><p>PySpark is the Python API for Spark. It allows for the creation of Spark DataFrames, which are similar to Pandas DataFrames, but with the added benefit of being distributed across a cluster of machines. PySpark DataFrames are the core data structure in PySpark, and they allow for the manipulation of large datasets in a distributed manner.</p><p>At the core of PySpark is the <code>SparkSession</code> object, which is what fundamentally interacts with Spark. This <code>SparkSession</code> is what allows for the creation of DataFrames, and other functionalities. Note that, when running a Notebook in Fabric, a <code>SparkSession</code> is automatically created for you, so you don&rsquo;t have to worry about that.</p><p>Having a rough idea of how PySpark works, let&rsquo;s get to the basics.</p><h2 class="relative group">Basics of PySpark<div id=basics-of-pyspark class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#basics-of-pyspark aria-label=Anchor>#</a></span></h2><p>Although Spark DataFrames may remind us of Pandas DataFrames due to their similarities, the syntax when using PySpark can be a bit different. In this section, we&rsquo;ll go over some of the basics of PySpark, such as reading data, combining DataFrames, selecting columns, grouping data, joining DataFrames, and using functions.</p><h3 class="relative group">The Data<div id=the-data class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#the-data aria-label=Anchor>#</a></span></h3><p>The data we are looking at is from the 2024 US college basketball tournaments, which was obtained from the on-going March Machine Learning Mania 2024 Kaggle competition, the details of which can be found <a href="https://medium.com/r/?url=https%3A%2F%2Fwww.kaggle.com%2Fcompetitions%2Fmarch-machine-learning-mania-2024%2Foverview" target=_blank>here</a>, and is licensed under CC BY 4.0</p><h3 class="relative group">Reading data<div id=reading-data class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#reading-data aria-label=Anchor>#</a></span></h3><p>As mentioned in the <a href=/posts/fabric-madness-1/>previous post</a> of this series, the first step is usually to create a Lakehouse and upload some data. Then, when creating a Notebook, we can attach it to the created Lakehouse, and we&rsquo;ll have access to the data stored there.</p><p>PySpark Dataframes can read various data formats, such as CSV, JSON, Parquet, and others. Our data is stored in CSV format, so we&rsquo;ll be using that, like in the following code snippet:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Read women&#39;s data</span>
</span></span><span class=line><span class=cl><span class=n>w_data</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>spark</span><span class=o>.</span><span class=n>read</span><span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s2>&#34;header&#34;</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s2>&#34;inferSchema&#34;</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>csv</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Files/WNCAATourneyDetailedResults.csv&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>cache</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>In this code snippet, we&rsquo;re reading the detailed results data set of the final women&rsquo;s basketball college tournament matches. Note that the <code>"header"</code> option being true means that the names of the columns will be derived from the first row of the CSV file. The <code>inferSchema</code> option tells Spark to guess the data types of the columns - otherwise they would all be read as strings. <code>.cache()</code> is used to keep the DataFrame in memory.</p><p>If you&rsquo;re coming from Pandas, you may be wondering what the equivalent of <code>df.head()</code> is for PySpark - it&rsquo;s <code>df.show(5)</code>. The default for <code>.show()</code> is the top 20 rows, hence the need to specifically select 5.</p><h3 class="relative group">Combining DataFrames<div id=combining-dataframes class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#combining-dataframes aria-label=Anchor>#</a></span></h3><p>Combining DataFrames can be done in multiple ways. The first we will look at is a union, where the columns are the same for both DataFrames:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Read women&#39;s data</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Read men&#39;s data</span>
</span></span><span class=line><span class=cl><span class=n>m_data</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>spark</span><span class=o>.</span><span class=n>read</span><span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s2>&#34;header&#34;</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s2>&#34;inferSchema&#34;</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>csv</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Files/MNCAATourneyDetailedResults.csv&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>cache</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Combine (union) the DataFrames</span>
</span></span><span class=line><span class=cl><span class=n>combined_results</span> <span class=o>=</span> <span class=n>m_data</span><span class=o>.</span><span class=n>unionByName</span><span class=p>(</span><span class=n>w_data</span><span class=p>)</span>
</span></span></code></pre></div><p>Here, <code>unionByName</code> joins the two DataFrames by matching the names of the columns. Since both the women&rsquo;s and the men&rsquo;s <em>detailed match results</em> have the same columns, this is a good approach. Alternatively, there&rsquo;s also <code>union</code>, which combines two Dataframes, matching column positions.</p><h3 class="relative group">Selecting Columns<div id=selecting-columns class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#selecting-columns aria-label=Anchor>#</a></span></h3><p>Selecting columns from a DataFrame in PySpark can be done using the <code>.select()</code> method. We just have to indicate the name or names of the columns that are relevant as a parameter.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Selecting a single column</span>
</span></span><span class=line><span class=cl><span class=n>w_scores</span> <span class=o>=</span> <span class=n>w_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&#34;WScore&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Selecting multiple columns</span>
</span></span><span class=line><span class=cl><span class=n>teamid_w_scores</span> <span class=o>=</span> <span class=n>w_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&#34;WTeamID&#34;</span><span class=p>,</span> <span class=s2>&#34;WScore&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>Here&rsquo;s the output for <code>w_scores.show(5)</code>:</p><pre tabindex=0><code>+------+
|Season|
+------+
|  2010|
|  2010|
|  2010|
|  2010|
|  2010|
+------+
only showing top 5 rows
</code></pre><p>The columns can also be renamed when being selected using the <code>.alias()</code> method:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>winners</span> <span class=o>=</span> <span class=n>w_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>w_data</span><span class=o>.</span><span class=n>WTeamID</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>&#34;TeamID&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>w_data</span><span class=o>.</span><span class=n>WScore</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>&#34;Score&#34;</span><span class=p>))</span>
</span></span></code></pre></div><h3 class="relative group">Grouping Data<div id=grouping-data class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#grouping-data aria-label=Anchor>#</a></span></h3><p>Grouping allows us to carry out certain operations for the groups that exist within the data and is usually combined with a aggregation functions. We can use <code>.groupBy()</code> for this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Grouping and aggregating</span>
</span></span><span class=line><span class=cl><span class=n>winners_average_scores</span> <span class=o>=</span> <span class=n>winners</span><span class=o>.</span><span class=n>groupBy</span><span class=p>(</span><span class=s2>&#34;TeamID&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>avg</span><span class=p>(</span><span class=s2>&#34;Score&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>In this example, we are grouping by <code>"TeamID"</code>, meaning we&rsquo;re considering the groups of rows that have a distinct value for <code>"TeamID"</code>. For each of those groups, we&rsquo;re calculating the average of the <code>"Score"</code>. This way, we get the average score for each team.</p><p>Here&rsquo;s the output of <code>winners_average_scores.show(5)</code>, showing the average score of each team:</p><pre tabindex=0><code>+------+-----------------+
|TeamID|       avg(Score)|
+------+-----------------+
|  3125|             68.5|
|  3345|             74.2|
|  3346|79.66666666666667|
|  3376|73.58333333333333|
|  3107|             61.0|
+------+-----------------+
</code></pre><h3 class="relative group">Joining Data<div id=joining-data class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#joining-data aria-label=Anchor>#</a></span></h3><p>Joining two DataFrames can be done using the <code>.join()</code> method. Joining is essentially extending the DataFrame by adding the columns of one DataFrame to another.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Joining on Season and TeamID</span>
</span></span><span class=line><span class=cl><span class=n>final_df</span> <span class=o>=</span> <span class=n>matches_df</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>stats_df</span><span class=p>,</span> <span class=n>on</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;Season&#39;</span><span class=p>,</span> <span class=s1>&#39;TeamID&#39;</span><span class=p>],</span> <span class=n>how</span><span class=o>=</span><span class=s1>&#39;left&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>In this example, both <code>stats_df</code> and <code>matches_df</code> were using <code>Season</code> and <code>TeamID</code> as unique identifiers for each row. Besides <code>Season</code> and <code>TeamID</code>, <code>stats_df</code> has other columns, such as statistics for each team during each season, whereas <code>matches_df</code> has information about the matches, such as date and location. This operation allows us to add those interesting statistics to the matches information!</p><h3 class="relative group">Functions<div id=functions class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#functions aria-label=Anchor>#</a></span></h3><p>There are several functions that PySpark provides that help us transform DataFrames. You can find the full list <a href=https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/functions.html target=_blank>here</a>.</p><p>Here&rsquo;s an example of a simple function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pyspark.sql</span> <span class=kn>import</span> <span class=n>functions</span> <span class=k>as</span> <span class=n>F</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>w_data</span> <span class=o>=</span> <span class=n>w_data</span><span class=o>.</span><span class=n>withColumn</span><span class=p>(</span><span class=s2>&#34;HighScore&#34;</span><span class=p>,</span> <span class=n>F</span><span class=o>.</span><span class=n>when</span><span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>&#34;Score&#34;</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>80</span><span class=p>,</span> <span class=s2>&#34;Yes&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>otherwise</span><span class=p>(</span><span class=s2>&#34;No&#34;</span><span class=p>))</span>
</span></span></code></pre></div><p>In the code snippet above, a <code>"HighScore"</code> column is created when the score is higher than 80. For each row in the <code>"Score"</code> column (indicated by the <code>.col()</code> function), the value <code>"Yes"</code> is chosen for the <code>"HighScore"</code> column if the <code>"Score"</code> value is larger than 80, determined by the <code>.when()</code> function. <code>.otherwise()</code>, the value chosen is <code>"No"</code>.</p><h2 class="relative group">Feature Engineering in Action<div id=feature-engineering-in-action class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#feature-engineering-in-action aria-label=Anchor>#</a></span></h2><h3 class="relative group">Regular Season Statistics<div id=regular-season-statistics class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#regular-season-statistics aria-label=Anchor>#</a></span></h3><p>Now that we have a basic understanding of PySpark and how it can be used, let&rsquo;s go over how the regular season statistics features were created. These features were then used as inputs into our machine learning model to try to predict the outcome of the final tournament games.</p><p>The starting point was a DataFrame, <code>regular_data</code>, that contained match by match statistics for the <em>regular seasons</em>, which is the United States College Basketball Season that happens from November to March each year.</p><p>Each row in this DataFrame contained the season, the day the match was held, the ID of team 1, the ID of team 2, and other information such as the location of the match. Importantly, it also contained statistics for <em>each team</em> for that <em>specific match</em>, such as <code>"T1_FGM"</code>, meaning the Field Goals Made (FGM) for team 1, or <code>"T2_OR"</code>, meaning the Offensive Rebounds (OR) of team 2.</p><p>The first step was selecting which columns would be used. These were columns that strictly contained in-game statistics.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Columns that we&#39;ll want to get statistics from</span>
</span></span><span class=line><span class=cl><span class=n>boxscore_cols</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;T1_FGM&#39;</span><span class=p>,</span> <span class=s1>&#39;T1_FGA&#39;</span><span class=p>,</span> <span class=s1>&#39;T1_FGM3&#39;</span><span class=p>,</span> <span class=s1>&#39;T1_FGA3&#39;</span><span class=p>,</span> <span class=s1>&#39;T1_OR&#39;</span><span class=p>,</span> <span class=s1>&#39;T1_DR&#39;</span><span class=p>,</span> <span class=s1>&#39;T1_Ast&#39;</span><span class=p>,</span> <span class=s1>&#39;T1_Stl&#39;</span><span class=p>,</span> <span class=s1>&#39;T1_PF&#39;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=s1>&#39;T2_FGM&#39;</span><span class=p>,</span> <span class=s1>&#39;T2_FGA&#39;</span><span class=p>,</span> <span class=s1>&#39;T2_FGM3&#39;</span><span class=p>,</span> <span class=s1>&#39;T2_FGA3&#39;</span><span class=p>,</span> <span class=s1>&#39;T2_OR&#39;</span><span class=p>,</span> <span class=s1>&#39;T2_DR&#39;</span><span class=p>,</span> <span class=s1>&#39;T2_Ast&#39;</span><span class=p>,</span> <span class=s1>&#39;T2_Stl&#39;</span><span class=p>,</span> <span class=s1>&#39;T2_PF&#39;</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></div><p>If you&rsquo;re interested, here&rsquo;s what each statistic&rsquo;s code means:</p><ul><li>FGM: Field Goals Made</li><li>FGA: Field Goals Attempted</li><li>FGM3: Field Goals Made from the 3-point-line</li><li>FGA3: Field Goals Attempted for 3-point-line goals</li><li>OR: Offensive Rebounds. A rebounds is when the ball rebounds from the board when a goal is attempted, not getting in the net. If the team that <em>attempted</em> the goal gets possession of the ball, it&rsquo;s called an &ldquo;Offensive&rdquo; rebound. Otherwise, it&rsquo;s called a &ldquo;Defensive&rdquo; Rebound.</li><li>DR: Defensive Rebounds</li><li>Ast: Assist, a pass that led directly to a goal</li><li>Stl: Steal, when the possession of the ball is stolen</li><li>PF: Personal Foul, when a player makes a foul</li></ul><p>From there, a dictionary of <em>aggregation expressions</em> was created. Basically, for each column name in the previous list of columns, a function was stored that would calculate the mean of the column, and rename it, by adding a suffix, <code>"mean"</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pyspark.sql</span> <span class=kn>import</span> <span class=n>functions</span> <span class=k>as</span> <span class=n>F</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pyspark.sql.functions</span> <span class=kn>import</span> <span class=n>col</span>  <span class=c1># select a column</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agg_exprs</span> <span class=o>=</span> <span class=p>{</span><span class=n>col</span><span class=p>:</span> <span class=n>F</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>col</span><span class=p>)</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=n>col</span> <span class=o>+</span> <span class=s1>&#39;mean&#39;</span><span class=p>)</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>boxscore_cols</span><span class=p>}</span>
</span></span></code></pre></div><p>Then, the data was grouped by <code>"Season"</code> and <code>"T1_TeamID"</code>, and the aggregation functions of the previously created dictionary were used as the argument for <code>.agg()</code>. Note that <code>(*agg_exprs.values())</code> is the same as <code>(F.mean('T1_FGM').alias('T1_FGMmean'), F.mean('T1_FGA').alias('T1_FGAmean'), ..., F.mean('T2_PF').alias('T2_PFmean'))</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>season_statistics</span> <span class=o>=</span> <span class=n>regular_data</span><span class=o>.</span><span class=n>groupBy</span><span class=p>([</span><span class=s2>&#34;Season&#34;</span><span class=p>,</span> <span class=s2>&#34;T1_TeamID&#34;</span><span class=p>])</span><span class=o>.</span><span class=n>agg</span><span class=p>(</span><span class=o>*</span><span class=n>agg_exprs</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
</span></span></code></pre></div><p>Note that the grouping was done by season and the <strong>ID of team 1</strong> - this means that <code>"T2_FGAmean"</code>, for example, will actually be the mean of the Field Goals Attempted made by the <strong>opponents</strong> of T1, not necessarily of a specific team. So, we actually need to rename the columns that are something like <code>"T2_FGAmean"</code> to something like <code>"T1_opponent_FGAmean"</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Rename columns for T1</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>boxscore_cols</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>season_statistics</span> <span class=o>=</span> <span class=n>season_statistics</span><span class=o>.</span><span class=n>withColumnRenamed</span><span class=p>(</span><span class=n>col</span> <span class=o>+</span> <span class=s1>&#39;mean&#39;</span><span class=p>,</span> <span class=s1>&#39;T1_&#39;</span> <span class=o>+</span> <span class=n>col</span><span class=p>[</span><span class=mi>3</span><span class=p>:]</span> <span class=o>+</span> <span class=s1>&#39;mean&#39;</span><span class=p>)</span> <span class=k>if</span> <span class=s1>&#39;T1_&#39;</span> <span class=ow>in</span> <span class=n>col</span> \
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=n>season_statistics</span><span class=o>.</span><span class=n>withColumnRenamed</span><span class=p>(</span><span class=n>col</span> <span class=o>+</span> <span class=s1>&#39;mean&#39;</span><span class=p>,</span> <span class=s1>&#39;T1_opponent_&#39;</span> <span class=o>+</span> <span class=n>col</span><span class=p>[</span><span class=mi>3</span><span class=p>:]</span> <span class=o>+</span> <span class=s1>&#39;mean&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>At this point, it&rsquo;s important to mention that the <code>regular_data</code> DataFrame actually has <strong>two</strong> rows per each match that occurred. This is so that both teams can be &ldquo;T1&rdquo; and &ldquo;T2&rdquo;, for each match. This little &ldquo;trick&rdquo; is what makes these statistics useful.</p><p>Note that we &ldquo;only&rdquo; have the statistics for &ldquo;T1&rdquo;. We &ldquo;need&rdquo; the statistics for &ldquo;T2&rdquo; as well - &ldquo;need&rdquo; in quotations because there are no new statistics being calculated. We just need the same data, but with the columns having different names, so that for a match with &ldquo;T1&rdquo; and &ldquo;T2&rdquo;, we have statistics for both T1 and T2. So, we created a mirror DataFrame, where, instead of &ldquo;T1&mldr;mean&rdquo; and &ldquo;T1_opponent_&mldr;mean&rdquo;, we have &ldquo;T2&mldr;mean&rdquo; and &ldquo;T2_opponent_&mldr;mean&rdquo;. This is important because, later on, when we&rsquo;re joining these regular season statistics to tournament matches, we&rsquo;ll be able to have statistics for both team 1 <strong>and</strong> team 2.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>season_statistics_T2</span> <span class=o>=</span> <span class=n>season_statistics</span><span class=o>.</span><span class=n>select</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>[</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=n>col</span><span class=p>)</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=n>col</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;T1_opponent_&#39;</span><span class=p>,</span> <span class=s1>&#39;T2_opponent_&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;T1_&#39;</span><span class=p>,</span> <span class=s1>&#39;T2_&#39;</span><span class=p>))</span> <span class=k>if</span> <span class=n>col</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;Season&#39;</span><span class=p>]</span> <span class=k>else</span> <span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=n>col</span><span class=p>)</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>season_statistics</span><span class=o>.</span><span class=n>columns</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>Now, there are two DataFrames, with season statistics for &ldquo;both&rdquo; T1 and T2. Since the final dataframe will contain the &ldquo;Season&rdquo;, the &ldquo;T1TeamID&rdquo; and the &ldquo;T2TeamID&rdquo;, we can join these newly created features with a join!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>tourney_df</span> <span class=o>=</span> <span class=n>tourney_df</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>season_statistics</span><span class=p>,</span> <span class=n>on</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;Season&#39;</span><span class=p>,</span> <span class=s1>&#39;T1_TeamID&#39;</span><span class=p>],</span> <span class=n>how</span><span class=o>=</span><span class=s1>&#39;left&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tourney_df</span> <span class=o>=</span> <span class=n>tourney_df</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>season_statistics_T2</span><span class=p>,</span> <span class=n>on</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;Season&#39;</span><span class=p>,</span> <span class=s1>&#39;T2_TeamID&#39;</span><span class=p>],</span> <span class=n>how</span><span class=o>=</span><span class=s1>&#39;left&#39;</span><span class=p>)</span>
</span></span></code></pre></div><h3 class="relative group">Elo Ratings<div id=elo-ratings class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#elo-ratings aria-label=Anchor>#</a></span></h3><p>First created by <a href=https://en.wikipedia.org/wiki/Elo_rating_system target=_blank>Arpad Elo</a>, Elo is a rating system for zero-sum games (games where one player wins and the other loses), like basketball. With the Elo rating system, each team has an Elo rating, a value that generally conveys the team&rsquo;s quality. At first, every team has the same Elo, and whenever they win, their Elo increases, and when they lose, their Elo decreases. A key characteristic of this system is that this value increases more with a win against a strong opponent than with a win against a weak opponent. Thus, it can be a very useful feature to have!</p><p>We wanted to capture the Elo rating of a team at the end of the regular season, and use that as feature for the tournament. To do this, we calculated the Elo for each team on a per match basis. To calculate Elo for this feature, we found it more straightforward to use Pandas.</p><p>Central to Elo is calculating the expected score for each team. It can be described in code like so:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Function to calculate expected score</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>expected_score</span><span class=p>(</span><span class=n>ra</span><span class=p>,</span> <span class=n>rb</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># ra = rating (Elo) team A</span>
</span></span><span class=line><span class=cl>    <span class=c1># rb = rating (Elo) team B</span>
</span></span><span class=line><span class=cl>    <span class=c1># Elo function</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=mi>10</span> <span class=o>**</span> <span class=p>((</span><span class=n>rb</span> <span class=o>-</span> <span class=n>ra</span><span class=p>)</span> <span class=o>/</span> <span class=mi>400</span><span class=p>))</span>
</span></span></code></pre></div><p>Considering a team A and a team B, this function computes the expected score of team A against team B.</p><p>For each match, we would update the teams&rsquo; Elos. Note that the location of the match also played a part - winning at home was considered less impressive than winning away.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Function to update Elo ratings, keeping T1 and T2 terminology</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_elo</span><span class=p>(</span><span class=n>t1_elo</span><span class=p>,</span> <span class=n>t2_elo</span><span class=p>,</span> <span class=n>location</span><span class=p>,</span> <span class=n>T1_Score</span><span class=p>,</span> <span class=n>T2_Score</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>expected_t1</span> <span class=o>=</span> <span class=n>expected_score</span><span class=p>(</span><span class=n>t1_elo</span><span class=p>,</span> <span class=n>t2_elo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>expected_t2</span> <span class=o>=</span> <span class=n>expected_score</span><span class=p>(</span><span class=n>t2_elo</span><span class=p>,</span> <span class=n>t1_elo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>actual_t1</span> <span class=o>=</span> <span class=mi>1</span> <span class=k>if</span> <span class=n>T1_Score</span> <span class=o>&gt;</span> <span class=n>T2_Score</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>actual_t2</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>actual_t1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Determine K based on game location</span>
</span></span><span class=line><span class=cl>    <span class=c1># The larger the K, the bigger the impact</span>
</span></span><span class=line><span class=cl>    <span class=c1># team1 winning at home (location=1) less impressive than winning away (location = -1)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>actual_t1</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>  <span class=c1># team1 won</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>location</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=o>=</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>location</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=o>=</span> <span class=mi>30</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>  <span class=c1># location = -1</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=o>=</span> <span class=mi>40</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>  <span class=c1># team2 won</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>location</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=o>=</span> <span class=mi>40</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>location</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=o>=</span> <span class=mi>30</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>  <span class=c1># location = -1</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=o>=</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>new_t1_elo</span> <span class=o>=</span> <span class=n>t1_elo</span> <span class=o>+</span> <span class=n>k</span> <span class=o>*</span> <span class=p>(</span><span class=n>actual_t1</span> <span class=o>-</span> <span class=n>expected_t1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>new_t2_elo</span> <span class=o>=</span> <span class=n>t2_elo</span> <span class=o>+</span> <span class=n>k</span> <span class=o>*</span> <span class=p>(</span><span class=n>actual_t2</span> <span class=o>-</span> <span class=n>expected_t2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>new_t1_elo</span><span class=p>,</span> <span class=n>new_t2_elo</span>
</span></span></code></pre></div><p>To apply the Elo rating system, we iterated through each season&rsquo;s matches, initializing teams with a base rating and updating their ratings match by match. The final Elo available for each team in each season will, hopefully, be a good descriptor of the team&rsquo;s quality.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_elo_through_seasons</span><span class=p>(</span><span class=n>regular_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># For this feature, using Pandas</span>
</span></span><span class=line><span class=cl>    <span class=n>regular_data</span> <span class=o>=</span> <span class=n>regular_data</span><span class=o>.</span><span class=n>toPandas</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># Set value of initial elo</span>
</span></span><span class=line><span class=cl>    <span class=n>initial_elo</span> <span class=o>=</span> <span class=mi>1500</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># DataFrame to collect final Elo ratings</span>
</span></span><span class=line><span class=cl>    <span class=n>final_elo_list</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>season</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>regular_data</span><span class=p>[</span><span class=s1>&#39;Season&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Season: </span><span class=si>{</span><span class=n>season</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># Initialize elo ratings dictionary</span>
</span></span><span class=line><span class=cl>        <span class=n>elo_ratings</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Processing Season: </span><span class=si>{</span><span class=n>season</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># Get the teams that played in the season</span>
</span></span><span class=line><span class=cl>        <span class=n>season_teams</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>regular_data</span><span class=p>[</span><span class=n>regular_data</span><span class=p>[</span><span class=s1>&#39;Season&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>season</span><span class=p>][</span><span class=s1>&#39;T1_TeamID&#39;</span><span class=p>])</span><span class=o>.</span><span class=n>union</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>regular_data</span><span class=p>[</span><span class=n>regular_data</span><span class=p>[</span><span class=s1>&#39;Season&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>season</span><span class=p>][</span><span class=s1>&#39;T2_TeamID&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># Initialize season teams&#39; Elo ratings</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>team</span> <span class=ow>in</span> <span class=n>season_teams</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>season</span><span class=p>,</span> <span class=n>team</span><span class=p>)</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>elo_ratings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>elo_ratings</span><span class=p>[(</span><span class=n>season</span><span class=p>,</span> <span class=n>team</span><span class=p>)]</span> <span class=o>=</span> <span class=n>initial_elo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Update Elo ratings per game</span>
</span></span><span class=line><span class=cl>        <span class=n>season_games</span> <span class=o>=</span> <span class=n>regular_data</span><span class=p>[</span><span class=n>regular_data</span><span class=p>[</span><span class=s1>&#39;Season&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>season</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>season_games</span><span class=o>.</span><span class=n>iterrows</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>t1_elo</span> <span class=o>=</span> <span class=n>elo_ratings</span><span class=p>[(</span><span class=n>season</span><span class=p>,</span> <span class=n>row</span><span class=p>[</span><span class=s1>&#39;T1_TeamID&#39;</span><span class=p>])]</span>
</span></span><span class=line><span class=cl>            <span class=n>t2_elo</span> <span class=o>=</span> <span class=n>elo_ratings</span><span class=p>[(</span><span class=n>season</span><span class=p>,</span> <span class=n>row</span><span class=p>[</span><span class=s1>&#39;T2_TeamID&#39;</span><span class=p>])]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>new_t1_elo</span><span class=p>,</span> <span class=n>new_t2_elo</span> <span class=o>=</span> <span class=n>update_elo</span><span class=p>(</span><span class=n>t1_elo</span><span class=p>,</span> <span class=n>t2_elo</span><span class=p>,</span> <span class=n>row</span><span class=p>[</span><span class=s1>&#39;location&#39;</span><span class=p>],</span> <span class=n>row</span><span class=p>[</span><span class=s1>&#39;T1_Score&#39;</span><span class=p>],</span> <span class=n>row</span><span class=p>[</span><span class=s1>&#39;T2_Score&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># Only keep the last season rating</span>
</span></span><span class=line><span class=cl>            <span class=n>elo_ratings</span><span class=p>[(</span><span class=n>season</span><span class=p>,</span> <span class=n>row</span><span class=p>[</span><span class=s1>&#39;T1_TeamID&#39;</span><span class=p>])]</span> <span class=o>=</span> <span class=n>new_t1_elo</span>
</span></span><span class=line><span class=cl>            <span class=n>elo_ratings</span><span class=p>[(</span><span class=n>season</span><span class=p>,</span> <span class=n>row</span><span class=p>[</span><span class=s1>&#39;T2_TeamID&#39;</span><span class=p>])]</span> <span class=o>=</span> <span class=n>new_t2_elo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Collect final Elo ratings for the season</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>team</span> <span class=ow>in</span> <span class=n>season_teams</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>final_elo_list</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s1>&#39;Season&#39;</span><span class=p>:</span> <span class=n>season</span><span class=p>,</span> <span class=s1>&#39;TeamID&#39;</span><span class=p>:</span> <span class=n>team</span><span class=p>,</span> <span class=s1>&#39;Elo&#39;</span><span class=p>:</span> <span class=n>elo_ratings</span><span class=p>[(</span><span class=n>season</span><span class=p>,</span> <span class=n>team</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Convert list to DataFrame</span>
</span></span><span class=line><span class=cl>    <span class=n>final_elo_df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>final_elo_list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Separate DataFrames for T1 and T2</span>
</span></span><span class=line><span class=cl>    <span class=n>final_elo_t1_df</span> <span class=o>=</span> <span class=n>final_elo_df</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=n>columns</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;TeamID&#39;</span><span class=p>:</span> <span class=s1>&#39;T1_TeamID&#39;</span><span class=p>,</span> <span class=s1>&#39;Elo&#39;</span><span class=p>:</span> <span class=s1>&#39;T1_Elo&#39;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=n>final_elo_t2_df</span> <span class=o>=</span> <span class=n>final_elo_df</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=n>columns</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;TeamID&#39;</span><span class=p>:</span> <span class=s1>&#39;T2_TeamID&#39;</span><span class=p>,</span> <span class=s1>&#39;Elo&#39;</span><span class=p>:</span> <span class=s1>&#39;T2_Elo&#39;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Convert the pandas DataFrames back to Spark DataFrames</span>
</span></span><span class=line><span class=cl>    <span class=n>final_elo_t1_df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>createDataFrame</span><span class=p>(</span><span class=n>final_elo_t1_df</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>final_elo_t2_df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>createDataFrame</span><span class=p>(</span><span class=n>final_elo_t2_df</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>final_elo_t1_df</span><span class=p>,</span> <span class=n>final_elo_t2_df</span>
</span></span></code></pre></div><p>Ideally, we wouldn&rsquo;t calculate Elo changes on a match-by-match basis to determine each team&rsquo;s final Elo for the season. However, we couldn&rsquo;t come up with a better approach. Do you have any ideas? If so, let us know!</p><h3 class="relative group">Value Added<div id=value-added class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#value-added aria-label=Anchor>#</a></span></h3><p>The feature engineering steps demonstrated show how we can transform raw data - regular season statistics - into valuable information with predictive power. It is reasonable to assume that a team&rsquo;s performance during the regular season is indicative of its potential performance in the final tournaments. By calculating the mean of observed match-by-match statistics for both the teams and their opponents, along with each team&rsquo;s Elo rating in their final match, we were able to create a dataset suitable for modelling. Then, models were trained to predict the outcome of tournament matches using these features, among others developed in a similar way. With these models, we only need the two team IDs to look up the mean of their regular season statistics and their Elos to feed into the model and predict a score!</p><h2 class="relative group">Conclusion<div id=conclusion class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#conclusion aria-label=Anchor>#</a></span></h2><p>In this post, we looked at some of the theory behind Spark and PySpark, how that can be applied, and a concrete practical example. We explored how feature engineering can be done in the case of sports data, creating regular season statistics to use as features for final tournament games. Hopefully you&rsquo;ve found this interesting and helpful - happy feature engineering!</p></div><details style=margin-left:0 class="mt-2 mb-5 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5"><summary class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">Fabric Madness - This article is part of a series.</summary><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://nobledynamic.github.io/posts/fabric-madness-1/>Part 1: Fabric Madness: predicting basketball games with Microsoft Fabric</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">Part 2: This Article</div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://nobledynamic.github.io/posts/fabric-madness-3/>Part 3: Fabric Madness: Feature Engineering with Dataflow Gen2</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://nobledynamic.github.io/posts/fabric-madness-4/>Part 4: Fabric Madness: Experiments</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://nobledynamic.github.io/posts/fabric-madness-5/>Part 5: Fabric Madness: Models</a></div></details></div><script>var oid="views_posts/fabric-madness-2/index.md",oid_likes="likes_posts/fabric-madness-2/index.md"</script><script type=text/javascript src=/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q+oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/fabric-madness-1/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Fabric Madness: predicting basketball games with Microsoft Fabric</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2024-04-01 19:00:43 +0000 UTC">1 April 2024</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/posts/fabric-madness-3/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Fabric Madness: Feature Engineering with Dataflow Gen2</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2024-04-15 11:37:43 +0000 UTC">15 April 2024</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 px-4 print:hidden" style=padding-top:10rem><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/terms-conditions/ title>Terms & Conditions</a></li><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/disclaimer/ title>Disclaimer</a></li><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/privacy-policy/ title>Privacy</a></li><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=https://twitter.com/Roger_Noble title><span><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span></span></a></li><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=https://www.linkedin.com/company/noble-dynamic title><span><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></span></span></a></li><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=https://github.com/nobledynamic title><span><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">© 2024 Noble Dynamic Limited</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://nobledynamic.github.io/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>